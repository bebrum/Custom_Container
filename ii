import openpyxl
from datetime import datetime, date
import matplotlib.pyplot as plt
from collections import defaultdict

# Настройки
INPUT_FILE = "your_file.xlsx"  # Замените на имя вашего файла
DATE_COLUMN = 0  # Номер столбца с датами (0 - первый столбец)
CHART_TITLE = "Количество записей по дням"
OUTPUT_CHART = "records_full_chart.png"

def analyze_records():
    # Загружаем книгу
    wb = openpyxl.load_workbook(INPUT_FILE)
    ws = wb.active
    
    # Создаем словарь для подсчета записей по дням
    date_dict = defaultdict(int)
    
    for row in ws.iter_rows(values_only=True):
        if not row[DATE_COLUMN]:
            continue
            
        # Обрабатываем дату (уже в формате datetime)
        try:
            if isinstance(row[DATE_COLUMN], datetime):
                record_date = row[DATE_COLUMN].date()
            else:
                # Если вдруг дата не в datetime формате, пробуем распарсить
                date_str = str(row[DATE_COLUMN]).split()[0]
                record_date = datetime.strptime(date_str, "%d.%m.%Y").date()
                
            date_dict[record_date] += 1
        except (AttributeError, ValueError) as e:
            print(f"Ошибка обработки даты: {row[DATE_COLUMN]} - {e}")
            continue
    
    if not date_dict:
        print("Нет данных для построения диаграммы!")
        return
    
    # Подготавливаем данные для диаграммы
    sorted_dates = sorted(date_dict.keys())
    dates = [d.strftime("%d.%m.%Y") for d in sorted_dates]
    counts = [date_dict[d] for d in sorted_dates]
    max_count = max(counts) if counts else 1
    
    # Строим диаграмму
    plt.figure(figsize=(14, 6))
    bars = plt.bar(dates, counts, color='#4b8bbe')
    
    # Настройки оформления
    plt.title(CHART_TITLE)
    plt.xlabel("Дата")
    plt.ylabel("Количество записей")
    plt.ylim(0, max_count + 1)
    plt.xticks(rotation=45, ha='right')
    plt.grid(axis='y', linestyle='--', alpha=0.7)
    
    # Добавляем значения над столбцами
    for bar in bars:
        height = bar.get_height()
        plt.text(bar.get_x() + bar.get_width()/2., height,
                 f'{height}',
                 ha='center', va='bottom')
    
    plt.tight_layout()
    plt.savefig(OUTPUT_CHART, dpi=300)
    print(f"Диаграмма сохранена как {OUTPUT_CHART}")
    
    # Выводим статистику
    print("\nСтатистика по дням:")
    for day, count in sorted(date_dict.items()):
        print(f"{day.strftime('%d.%m.%Y')}: {count} записей")
    
    plt.show()

if __name__ == "__main__":
    analyze_records()
